---
title: "Membench"
author: "K. Siek"
date: "November 23, 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Membench

A micro benchmark to show the memory usage of UFOs. This notebook runs and graphs memory consumption.

### Compiling and running the benchmark

Compile the benchmark.

```{bash}
make
```

Run the benchmark with parameters:

  - `size`  Size of the UFO (in elements of type `int64_t`),
  - `writes` The number of read operations between writes, zero for read-only,
  - `min-load` UFO chunk size (in bytes),
  - `high-water-mark`The threshold for memory used by materialized chunks before GC starts (in bytes),
  - `low-water-mark` Once GC starts, it removes chunks until this much memory is left (in bytes),

``` {bash}
./membench --size=$((10 * 1000 * 1000)) --writes=10 --min-load=$((4096)) --high-water-mark=$((100 * 1024)) --low-water-mark=$((1 * 1024))
```

### Memory and disk usage graph

Load R libraries:
```{r}
library(dplyr)
library(readr)
library(ggplot2)
library(gdata)
library(scales)
```

Helper functions
```{r}
KB <- function(x) { x * 1024 }
MB <- function(x) { x * 1024 * 1024 }
GB <- function(x) { x * 1024 * 1024 * 1024 }

find_memory_order <- function(x) {
  ifelse(x >= GB(10), GB, ifelse(x >= MB(10), MB, ifelse(x >= KB(10), KB, function(x) x)))
}

# labels_nanoseconds <- function(x) {
#   ifelse(abs(x) < 1000, paste0(x, "ns"),
#          ifelse(abs(x) < 1000 * 1000, paste0(x, "Âµs"), 
#                 ifelse(x < 1000 * 1000, paste0(x, "ms"))
#                 )
#   )
# }
```

Ingest the data
```{r}
data <- read_csv("membench.csv")
parameters <- read_csv("parameters.csv")
```

```{r fig.width=20, fig.height=10}

max_memory_usage <- max(data$memory_usage, data$intended_memory_usage, data$disk_usage, data$apparent_memory_usage, parameters$high_water_mark)
memory_order <- find_memory_order(max_memory_usage)
memory_breaks <- memory_order((0:(max_memory_usage / memory_order(1) / 10)) * 10)

memory_usage_color <- "#559CAD"
disk_usage_color <- "#8C5383"
ufo_perceived_color <- "black"
ufo_actual_color <- "black"
high_watermark_color <- "red"
low_watermark_color <- "red"

ggplot(data, aes(x=timestamp)) + 
  # Memory usage area
  geom_step(aes(y=memory_usage), color=memory_usage_color) +
  geom_rect(aes(xmin=timestamp,xmax=lead(timestamp),ymin=0,ymax=memory_usage), fill=memory_usage_color, alpha=0.9) +
  # Disk usage area
  geom_step(aes(y=disk_usage), color=disk_usage_color) +
  geom_rect(aes(xmin=timestamp,xmax=lead(timestamp),ymin=0,ymax=disk_usage), fill=disk_usage_color, alpha=0.9) +
  # UFO sizes
  geom_step(aes(y=intended_memory_usage), color=ufo_perceived_color, size=1) +
  geom_step(aes(y=apparent_memory_usage), color=ufo_actual_color, size=0.5, linetype = "dashed") +
  # Threshods
  geom_hline(yintercept=parameters$high_water_mark, color=high_watermark_color, linetype = "dashed") +
  geom_hline(yintercept=parameters$low_water_mark, color=low_watermark_color, linetype = "dashed") +
  # Theming
  theme_linedraw() + 
  scale_y_continuous(breaks=memory_breaks, labels = function(x) humanReadable(x, standard = "IEC", sep = "")) +
  scale_x_continuous(labels = function(x) paste0(floor(x / 1000 / 1000), "ms")) +
  theme(axis.title.y = element_blank(), axis.title.x = element_text("time"))
  
  #geom_line(aes(y=memory_usage)) #+ geom_line(aes(y=disk_usage)) #+ geom_line(aes(y=intended_memory_usage)) + geom_line(aes(y=apparent_memory_usage))
```
